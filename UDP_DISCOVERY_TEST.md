# UDP 发现功能测试指南

## 测试环境准备

### 1. 桌面端
```bash
# 启动桌面端应用
npm run dev
```

### 2. 手机端
```bash
# 启动 Web 开发服务器
npm run dev:web
```

## 测试步骤

### 测试 1：基本发现功能

1. **启动桌面端**
   - 运行桌面端应用
   - 确认 UDP 广播服务已启动（端口 3001）
   - 确认 Web 服务器已启动（端口 8080）

2. **打开手机端**
   - 在手机浏览器中访问 `http://<桌面端IP>:5173`（开发模式）
   - 或访问 `http://<桌面端IP>:8080`（生产模式）

3. **验证自动发现**
   - 手机端应自动开始扫描
   - 观察浏览器控制台日志：
     ```
     [UDP Discovery] 本地 IP: 192.168.1.xxx
     [UDP Discovery] 发现服务器: { id, name, ip, port }
     ```
   - 应显示服务器选择界面

4. **选择服务器**
   - 点击发现的服务器
   - 应自动连接并刷新页面
   - 连接成功后应显示设备列表

### 测试 2：多服务器发现

1. **启动多个桌面端**
   - 在不同电脑上启动桌面端应用
   - 或在同一电脑上使用不同端口

2. **验证多服务器显示**
   - 手机端应显示所有发现的服务器
   - 每个服务器显示名称和 IP 地址

3. **选择不同服务器**
   - 依次连接不同服务器
   - 验证连接正确性

### 测试 3：服务器离线检测

1. **连接到服务器**
   - 手机端连接到桌面端

2. **关闭桌面端**
   - 关闭桌面端应用

3. **验证离线检测**
   - 15 秒后，服务器应从列表中移除
   - 观察控制台日志：
     ```
     [UDP Discovery] 服务器离线: <服务器名称>
     ```

### 测试 4：网络切换

1. **连接到服务器**
   - 手机端连接到桌面端

2. **切换 WiFi 网络**
   - 手机切换到不同的 WiFi 网络

3. **验证重新发现**
   - 应自动开始新的扫描
   - 如果在同一子网，应重新发现服务器

### 测试 5：探测接口

使用 curl 或浏览器直接测试探测接口：

```bash
# 测试探测接口
curl http://192.168.1.100:8080/api/info/probe

# 预期响应
{
  "id": "host",
  "deviceName": "我的电脑",
  "port": 8080,
  "timestamp": 1234567890
}
```

## 调试技巧

### 1. 查看控制台日志

**桌面端（Electron）**
```
打开开发者工具 -> Console
查找 [BroadcastDiscovery] 相关日志
```

**手机端（浏览器）**
```
打开浏览器开发者工具 -> Console
查找 [UDP Discovery] 相关日志
```

### 2. 网络抓包

使用 Wireshark 或 Charles 抓包：
- 过滤 UDP 端口 3001（广播）
- 过滤 HTTP 端口 8080（探测）

### 3. 检查防火墙

确保防火墙允许：
- UDP 端口 3001（广播）
- TCP 端口 8080（HTTP）

### 4. 检查网络配置

```bash
# Windows
ipconfig

# macOS/Linux
ifconfig

# 确认设备在同一子网
# 例如：192.168.1.x
```

## 常见问题

### 问题 1：无法发现服务器

**可能原因：**
- 不在同一局域网
- 防火墙阻止
- 端口被占用

**解决方法：**
1. 确认设备在同一 WiFi
2. 关闭防火墙测试
3. 检查端口占用：`netstat -an | grep 8080`

### 问题 2：发现速度慢

**可能原因：**
- 扫描 IP 范围过大
- 网络延迟高

**解决方法：**
1. 优化扫描范围（已实现）
2. 增加并发数（当前 10）
3. 减少超时时间（当前 2 秒）

### 问题 3：服务器列表不更新

**可能原因：**
- React 状态未更新
- 清理间隔过长

**解决方法：**
1. 检查 useUDPDiscovery Hook
2. 检查 ServerSelector 组件
3. 查看控制台错误

### 问题 4：CORS 错误

**可能原因：**
- 服务器未设置 CORS 头
- 浏览器安全策略

**解决方法：**
1. 确认服务器返回 CORS 头
2. 使用 HTTPS（生产环境）
3. 检查浏览器控制台错误

## 性能指标

### 预期性能

- **首次发现时间**：2-5 秒
- **扫描完整子网**：10-20 秒
- **服务器响应时间**：< 100ms
- **离线检测时间**：15 秒

### 优化建议

1. **减少扫描范围**
   - 只扫描常用 IP 范围
   - 使用缓存的 IP

2. **增加并发数**
   - 当前：10 个并发
   - 可增加到 20-30 个

3. **智能扫描**
   - 优先扫描最近连接的 IP
   - 使用 mDNS（如果支持）

## 测试清单

- [ ] 基本发现功能
- [ ] 多服务器发现
- [ ] 服务器离线检测
- [ ] 网络切换
- [ ] 探测接口
- [ ] 防火墙测试
- [ ] 性能测试
- [ ] CORS 测试
- [ ] 移动端测试
- [ ] 桌面端测试

## 总结

UDP 发现功能通过 HTTP 探测实现了自动发现局域网内的服务器。测试时需要注意网络配置、防火墙设置和浏览器安全策略。通过优化扫描策略和并发控制，可以在 2-5 秒内发现服务器，提供良好的用户体验。
