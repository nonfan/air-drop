<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®‰å…¨æœåŠ¡åˆå§‹åŒ–æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 24px;
    }
    h2 {
      color: #666;
      font-size: 18px;
      margin-bottom: 12px;
    }
    .status {
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 12px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.pending {
      background: #fff3cd;
      color: #856404;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    pre {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 4px;
    }
    .log-entry.success { color: #28a745; }
    .log-entry.error { color: #dc3545; }
    .log-entry.info { color: #17a2b8; }
  </style>
</head>
<body>
  <h1>ğŸ”’ å®‰å…¨æœåŠ¡åˆå§‹åŒ–æµ‹è¯•</h1>

  <div class="test-card">
    <h2>1. æµè§ˆå™¨æ”¯æŒæ£€æŸ¥</h2>
    <div id="browser-support"></div>
  </div>

  <div class="test-card">
    <h2>2. localStorage çŠ¶æ€</h2>
    <div id="storage-status"></div>
    <button onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰å®‰å…¨æ•°æ®</button>
  </div>

  <div class="test-card">
    <h2>3. å¯†é’¥ç”Ÿæˆæµ‹è¯•</h2>
    <div id="key-gen-status"></div>
    <button onclick="testKeyGeneration()">æµ‹è¯• RSA å¯†é’¥ç”Ÿæˆ</button>
    <button onclick="testAESEncryption()">æµ‹è¯• AES åŠ å¯†</button>
  </div>

  <div class="test-card">
    <h2>4. å®‰å…¨æœåŠ¡åˆå§‹åŒ–</h2>
    <div id="init-status"></div>
    <button onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
  </div>

  <div class="test-card">
    <h2>æµ‹è¯•æ—¥å¿—</h2>
    <div id="log" class="log"></div>
    <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
  </div>

  <script>
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // 1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    function checkBrowserSupport() {
      const div = document.getElementById('browser-support');
      const checks = [
        { name: 'Crypto API', test: typeof crypto !== 'undefined' },
        { name: 'SubtleCrypto', test: typeof crypto?.subtle !== 'undefined' },
        { name: 'localStorage', test: typeof localStorage !== 'undefined' },
        { name: 'HTTPS/localhost', test: location.protocol === 'https:' || location.hostname === 'localhost' }
      ];

      let html = '';
      let allPassed = true;

      checks.forEach(check => {
        const status = check.test ? 'âœ“' : 'âœ—';
        const className = check.test ? 'success' : 'error';
        html += `<div class="status ${className}">${status} ${check.name}</div><br>`;
        if (!check.test) allPassed = false;
        log(`${check.name}: ${check.test ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, check.test ? 'success' : 'error');
      });

      div.innerHTML = html;
      return allPassed;
    }

    // 2. æ£€æŸ¥ localStorage çŠ¶æ€
    function checkStorageStatus() {
      const div = document.getElementById('storage-status');
      
      const hasPrivateKey = localStorage.getItem('encrypted_private_key') !== null;
      const hasPublicKey = localStorage.getItem('public_key') !== null;
      const sessionKeys = Object.keys(localStorage).filter(k => k.startsWith('session_key_'));
      
      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          totalSize += key.length + localStorage[key].length;
        }
      }

      div.innerHTML = `
        <div class="status ${hasPrivateKey ? 'success' : 'pending'}">
          ç§é’¥: ${hasPrivateKey ? 'å·²å­˜åœ¨' : 'æœªç”Ÿæˆ'}
        </div><br>
        <div class="status ${hasPublicKey ? 'success' : 'pending'}">
          å…¬é’¥: ${hasPublicKey ? 'å·²å­˜åœ¨' : 'æœªç”Ÿæˆ'}
        </div><br>
        <div class="status info">
          ä¼šè¯å¯†é’¥: ${sessionKeys.length} ä¸ª
        </div><br>
        <div class="status info">
          å­˜å‚¨ä½¿ç”¨: ${(totalSize / 1024).toFixed(2)} KB
        </div>
      `;

      log(`å­˜å‚¨çŠ¶æ€ - ç§é’¥: ${hasPrivateKey}, å…¬é’¥: ${hasPublicKey}, ä¼šè¯å¯†é’¥: ${sessionKeys.length}`, 'info');
    }

    // æ¸…é™¤å­˜å‚¨
    function clearStorage() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å®‰å…¨æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å¯†é’¥å’Œé…å¯¹ä¿¡æ¯ã€‚')) {
        return;
      }

      localStorage.removeItem('encrypted_private_key');
      localStorage.removeItem('public_key');
      localStorage.removeItem('securitySettings');
      
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('session_key_')) {
          localStorage.removeItem(key);
        }
      });

      log('å·²æ¸…é™¤æ‰€æœ‰å®‰å…¨æ•°æ®', 'success');
      checkStorageStatus();
    }

    // 3. æµ‹è¯•å¯†é’¥ç”Ÿæˆ
    async function testKeyGeneration() {
      const div = document.getElementById('key-gen-status');
      div.innerHTML = '<div class="status pending">æµ‹è¯•ä¸­...</div>';
      log('å¼€å§‹æµ‹è¯• RSA å¯†é’¥ç”Ÿæˆ...', 'info');

      try {
        const keyPair = await crypto.subtle.generateKey(
          {
            name: 'RSA-OAEP',
            modulusLength: 2048,
            publicExponent: new Uint8Array([1, 0, 1]),
            hash: 'SHA-256'
          },
          true,
          ['encrypt', 'decrypt']
        );

        div.innerHTML = '<div class="status success">âœ“ RSA å¯†é’¥ç”ŸæˆæˆåŠŸ</div>';
        log('RSA å¯†é’¥ç”ŸæˆæˆåŠŸ', 'success');
      } catch (error) {
        div.innerHTML = `<div class="status error">âœ— RSA å¯†é’¥ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
        log(`RSA å¯†é’¥ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testAESEncryption() {
      const div = document.getElementById('key-gen-status');
      div.innerHTML = '<div class="status pending">æµ‹è¯•ä¸­...</div>';
      log('å¼€å§‹æµ‹è¯• AES åŠ å¯†...', 'info');

      try {
        const key = crypto.getRandomValues(new Uint8Array(32));
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          key.buffer,
          { name: 'AES-GCM' },
          false,
          ['encrypt', 'decrypt']
        );

        const testData = new TextEncoder().encode('Hello, World!');
        const encrypted = await crypto.subtle.encrypt(
          {
            name: 'AES-GCM',
            iv: iv.buffer,
            tagLength: 128
          },
          cryptoKey,
          testData
        );

        div.innerHTML = '<div class="status success">âœ“ AES åŠ å¯†æµ‹è¯•æˆåŠŸ</div>';
        log('AES åŠ å¯†æµ‹è¯•æˆåŠŸ', 'success');
      } catch (error) {
        div.innerHTML = `<div class="status error">âœ— AES åŠ å¯†æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
        log(`AES åŠ å¯†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // 4. æµ‹è¯•å®‰å…¨æœåŠ¡åˆå§‹åŒ–
    async function testInitialization() {
      const div = document.getElementById('init-status');
      div.innerHTML = '<div class="status pending">åˆå§‹åŒ–ä¸­...</div>';
      log('å¼€å§‹æµ‹è¯•å®‰å…¨æœåŠ¡åˆå§‹åŒ–...', 'info');

      try {
        // æ¨¡æ‹Ÿåˆå§‹åŒ–è¿‡ç¨‹
        log('æ­¥éª¤ 1: æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯†é’¥...', 'info');
        const hasPrivateKey = localStorage.getItem('encrypted_private_key') !== null;
        
        if (!hasPrivateKey) {
          log('æ­¥éª¤ 2: ç”Ÿæˆæ–°å¯†é’¥å¯¹...', 'info');
          const keyPair = await crypto.subtle.generateKey(
            {
              name: 'RSA-OAEP',
              modulusLength: 2048,
              publicExponent: new Uint8Array([1, 0, 1]),
              hash: 'SHA-256'
            },
            true,
            ['encrypt', 'decrypt']
          );

          log('æ­¥éª¤ 3: å¯¼å‡ºå…¬é’¥...', 'info');
          const publicKey = await crypto.subtle.exportKey('spki', keyPair.publicKey);
          const publicKeyPem = btoa(String.fromCharCode(...new Uint8Array(publicKey)));
          localStorage.setItem('public_key', `-----BEGIN PUBLIC KEY-----\n${publicKeyPem}\n-----END PUBLIC KEY-----`);

          log('æ­¥éª¤ 4: åŠ å¯†å¹¶å­˜å‚¨ç§é’¥...', 'info');
          // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ PBKDF2 æ´¾ç”Ÿå¯†é’¥
          localStorage.setItem('encrypted_private_key', 'test-encrypted-key');
        } else {
          log('æ­¥éª¤ 2: åŠ è½½ç°æœ‰å¯†é’¥...', 'info');
        }

        div.innerHTML = '<div class="status success">âœ“ åˆå§‹åŒ–æˆåŠŸ</div>';
        log('å®‰å…¨æœåŠ¡åˆå§‹åŒ–æˆåŠŸï¼', 'success');
        checkStorageStatus();
      } catch (error) {
        div.innerHTML = `<div class="status error">âœ— åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
        log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æŸ¥
    window.onload = function() {
      log('å¼€å§‹å®‰å…¨æœåŠ¡æµ‹è¯•...', 'info');
      checkBrowserSupport();
      checkStorageStatus();
    };
  </script>
</body>
</html>
